# Inapp HeadingBidding 应用内头部竞价


## 能力说明
**应用头部竞价(HB)** 可以让开发者在展示广告之前，通过竞价请求获取每个广告平台的出价，并通过竞价排序选出胜出者，只有胜出的广告平台才可以获得广告展示机会，进而使得广告展示的收益趋于最大化。  可以实现对每个广告位的请求进行优化, 实时的价格,可以减少运营维护, 提升开发者变现的透明度和主动权。
Suyi 聚合SDK需要对支持**应用内头部竞价**三方广告平台(ADN) SDK提供的竞价能力提供聚合竞价比价功能, App 竞价集成采用**移动应用端到ADN服务端(C2S)竞价**模式.

## 支持广告平台及类型
|   平台名称   |  广告类型  |   备注  |
|  -------- |  -------  |  ---- |
| Mintegral   | 开屏、原生信息流（仅模板)、激励视频、插屏视频、横幅广告 |  注：开屏需评估耗时；Mintegral 的插屏视频与苏伊的插屏广告不对应。需要对Suyi适配器做升级 |


##  功能说明及交互说明
### SDK端
HB功能建议与适配器解耦，作为独立作为独立组件或在核心SDK中提供。
#### 1. 时序图
![shixutu](../images/13.0/shixutu.png)  
#### 2. 关键步骤
1. 在广告位展示机会到来之前（启动时），需初始化完成Suyi及三方广告SDK，
2. 广告位展示机会到来之前，调用询价（竞价）请求接口，并等待对方服务器返回结果（**超时时长设计**）
3. SDK通过收集所有平台返回的询价结果，获取价格和bidtoken。
4. SDK通过价格排序规则判断出胜出平台，并按照要求完成对对应ADN的竞价成功、失败回调通知【非常重要】。
5. SDK把竞价胜出的HB广告源、与原瀑布流中的广告源按照CPM进行排序，生成新的瀑布流，参见[瀑布流价格排序规则](#3.瀑布流价格排序规则)
6. 若瀑布流中轮到HB广告源，则根据对应ADN的要求使用bidtoken调用广告加载接口进行广告加载。
7. 后续与普通广告业务流程一致
8. 除完成ADN对上报回调要求外，需要对Suyi后台上报统计信息参见[统计上报规则](#4.Suyi统计上报规则)
9. 询价流程 与 广告请求流程可以合并，但需要严格遵守次序。

#### 3.瀑布流价格排序规则
应用内头部竞价（HB）可与现有的或新的聚合瀑布流无缝衔接。每个HB广告来源均会与不参与HB的其他广告来源（例如广告瀑布流中的广告来源）竞争填充广告请求的机会。

**示例1. 聚合组仅有应用内头部竞价组**

![shili1](../images/13.0/shili1.png)

此聚合组中包含 4 个HB广告源。其中3个广告源返回出价。在本示例中，此聚合组中没有包含广告瀑布流中的广告来源。这意味着，出价最高的广告源将投放广告。  

公开出价广告来源仅在有广告可展示时才会出价。

**示例2. 聚合组仅有瀑布流、或HB竞价组都没有填充**

![shili2](../images/13.0/shili2.png)



1. 此聚合组中包含 4 个HB广告源。每个广告源都没有会返回出价。在本示例中，此聚合组中有四个广告瀑布流中的广告来源。则按正常的瀑布流请求。  
2. 此聚合组中没有 HB广告源。在本示例中，此聚合组中有四个广告瀑布流中的广告来源。则按正常的瀑布流请求。  

**示例3. 聚合组中有应用内头部竞价组和瀑布流**
![shili3](../images/13.0/shili3.png)

此聚合组中包含 4 个HB广告源。其中3个广告源返回出价。在本示例中，此聚合组中广告瀑布流中的广告来源的历史CPM，都低于ADN 3 。这意味着，出价最高的ADN 3广告源将投放广告。  

**示例4. 聚合组中有应用内头部竞价组和瀑布流**
![shili4](../images/13.0/shili4.png)
此聚合组中包含 4 个HB广告源。其中3个广告源返回出价。在本示例中，此聚合组中广告瀑布流中的广告来源的历史CPM，其中ADN A高于ADN 3 ，ADN 3 返回价格排序在第三位 。这意味着，出价最高的ADN A广告源将投放广告；或ADN A没有填充时，才会请求ADN 3。    

**5.其它情况**
- 若HB 中出现价格一致时，按平台优先级排序选择
- 若HB 中胜出价格与瀑布流价格一致时，HB优先

#### 4.头部竞价Suyi统计上报规则
此处统计上报指的是头部竞价中业务上报
1. 询价请求：ADN、 次数   \-\->   新增 询价请求数
2. 询价成功返回：ADN、次数  \-\->  新增 询价成功数
3. 竞价成功：ADN、 单价  \-\->  新增竞价成功数
4. 请求  \-\->   同瀑布流请求
5. 成功  \-\->  填充成功返回
6. 展示  \-\-> 同瀑布流 展示成功
7. 点击 \-\-> 同瀑布流 点击

其中 比价成功统计数据**暂不**在后台体现

### 服务端
1. 旧版本兼容
2. 苏伊广告位聚合中组Head Bidding配置（状态、 频控）
3. 上报数据统计

#### 设置规则
1. 支持广告类型：头部竞价 是只有特定广告平台的特定广告位类型 才可以使用。目前仅Mintegral支持，详见 [支持广告平台及类型](#支持广告平台及类型)
2. 属性修改：由于该权限是广告源基础属性，所以设置后不可修改
3. 动态eCPM：头部竞价的eCPM是动态的，所以广告源的底价CPM是不可用的
4. 频控方式变动：由于功能需要按CPM 进行瀑布流排序，会导致循环频控失效，循环频控和头部竞价只能二选一。
